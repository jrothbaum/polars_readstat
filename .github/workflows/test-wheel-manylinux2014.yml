name: Test wheel build (manylinux2014)

on:
  workflow_dispatch:

jobs:
  build-linux-legacy:
    name: Build wheel on Linux (manylinux2014 / RHEL7 compatible)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build wheel (manylinux2014 in Docker)
        run: |
          docker run --rm \
            -v "$PWD":/io \
            -w /io \
            -e RUST_BACKTRACE=full \
            -e CARGO_BUILD_JOBS=2 \
            -e CARGO_INCREMENTAL=0 \
            -e RUSTFLAGS="-C debuginfo=0 -C codegen-units=1" \
            quay.io/pypa/manylinux2014_x86_64:latest \
            /bin/bash -lc '
              curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              source ~/.cargo/env
              rustup toolchain install 1.88.0
              rustup default 1.88.0
              rustup target add x86_64-unknown-linux-gnu
              /opt/python/cp39-cp39/bin/pip install --upgrade pip maturin
              /opt/python/cp39-cp39/bin/maturin build --release --strip --out dist \
                --interpreter /opt/python/cp39-cp39/bin/python \
                --target x86_64-unknown-linux-gnu \
                --compatibility manylinux2014 \
                --jobs 2
            '
        shell: bash

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-manylinux2014-x86_64-test
          path: dist

